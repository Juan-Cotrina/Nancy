<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flujo de dinero e información en bancos</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Animaciones personalizadas adicionales si fueran necesarias */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        // --- Iconos SVG (Reemplazo de Lucide para evitar dependencias complejas) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Icons = {
            Building2: (props) => <IconBase {...props}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconBase>,
            Wallet: (props) => <IconBase {...props}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></IconBase>,
            User: (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            Landmark: (props) => <IconBase {...props}><line x1="3" y1="22" x2="21" y2="22"/><line x1="6" y1="18" x2="6" y2="11"/><line x1="10" y1="18" x2="10" y2="11"/><line x1="14" y1="18" x2="14" y2="11"/><line x1="18" y1="18" x2="18" y2="11"/><polygon points="12 2 20 7 4 7"/></IconBase>,
            Activity: (props) => <IconBase {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>,
            Database: (props) => <IconBase {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconBase>,
            Info: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>,
            Banknote: (props) => <IconBase {...props}><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></IconBase>,
            Send: (props) => <IconBase {...props}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></IconBase>,
            ArrowRight: (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>
        };

        const { useState, useEffect, useRef } = React;

        // --- Estilos y Utilidades ---
        const CURRENCY = "S/";
        const FORMAT_OPTS = { minimumFractionDigits: 2, maximumFractionDigits: 2 };

        const formatMoney = (amount) => `${CURRENCY} ${amount.toLocaleString('es-PE', FORMAT_OPTS)}`;

        // Componente para tarjetas de Entidad (Nodos)
        const EntityCard = ({ title, icon: Icon, balance, type, role, position, active }) => {
            const isBank = type === 'bank';
            const isCentral = type === 'central';
            
            return (
                <div className={`absolute p-4 rounded-xl border transition-all duration-500 flex flex-col items-center gap-2 w-48 shadow-lg
                ${position}
                ${active ? 'scale-110 ring-2 ring-emerald-400 shadow-emerald-500/20' : ''}
                ${isBank 
                    ? 'bg-slate-900 border-slate-700 text-slate-100 z-20' 
                    : isCentral 
                    ? 'bg-indigo-950 border-indigo-800 text-indigo-100' 
                    : 'bg-white border-slate-200 text-slate-800'
                }
                `}>
                <div className={`p-3 rounded-full ${isBank ? 'bg-emerald-500/20 text-emerald-400' : isCentral ? 'bg-indigo-500/20 text-indigo-400' : 'bg-blue-100 text-blue-600'}`}>
                    <Icon size={24} />
                </div>
                <div className="text-center">
                    <h3 className="font-bold text-sm">{title}</h3>
                    <p className="text-xs opacity-70 mb-1">{role}</p>
                    <div className="text-lg font-mono font-bold tracking-tight">
                    {formatMoney(balance)}
                    </div>
                </div>
                
                {/* Indicadores de Tasas */}
                {role === 'Ahorrista' && <div className="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">TREA: 4.5%</div>}
                {role === 'Prestatario' && <div className="text-xs bg-red-100 text-red-800 px-2 py-0.5 rounded-full">TCEA: 25.0%</div>}
                </div>
            );
        };

        // Componente para Partículas de Animación
        const FlowParticle = ({ start, end, type, onComplete, value }) => {
            const [pos, setPos] = useState(0); 
            const hasCompletedRef = useRef(false);
            
            useEffect(() => {
                let frameId;
                const animate = () => {
                setPos(prev => {
                    if (prev >= 100) {
                        return 100;
                    }
                    return prev + 1.5; 
                });
                frameId = requestAnimationFrame(animate);
                };
                frameId = requestAnimationFrame(animate);
                return () => cancelAnimationFrame(frameId);
            }, []);

            useEffect(() => {
                if (pos >= 100 && !hasCompletedRef.current) {
                hasCompletedRef.current = true;
                if (onComplete) {
                    onComplete();
                }
                }
            }, [pos, onComplete]);

            const getCoords = (loc) => {
                const positions = {
                'userA': { x: 20, y: 50 },
                'bank': { x: 50, y: 50 },
                'userB': { x: 80, y: 50 },
                'central': { x: 50, y: 20 },
                'network': { x: 50, y: 80 }
                };
                return positions[loc] || { x: 50, y: 50 };
            };

            const s = getCoords(start);
            const e = getCoords(end);
            
            const currentX = s.x + (e.x - s.x) * (pos / 100);
            const currentY = s.y + (e.y - s.y) * (pos / 100);

            const isMoney = type === 'money';

            return (
                <div 
                className="absolute z-50 pointer-events-none transition-transform"
                style={{ 
                    left: `${currentX}%`, 
                    top: `${currentY}%`,
                    transform: 'translate(-50%, -50%)'
                }}
                >
                <div className={`flex flex-col items-center animate-pulse`}>
                    <div className={`p-2 rounded-full shadow-lg ${isMoney ? 'bg-yellow-400 text-yellow-900 shadow-yellow-500/50' : 'bg-cyan-400 text-cyan-900 shadow-cyan-500/50'}`}>
                    {isMoney ? <Icons.Banknote size={16} /> : <Icons.Database size={16} />}
                    </div>
                    {value && (
                    <span className={`text-xs font-bold mt-1 px-1 rounded ${isMoney ? 'bg-yellow-100 text-yellow-800' : 'bg-cyan-100 text-cyan-800'}`}>
                        {value}
                    </span>
                    )}
                </div>
                </div>
            );
        };

        // Componente Principal
        const BankingSimulator = () => {
            const [balances, setBalances] = useState({
                userA: 5000,
                bank: 1000000,
                userB: 200,
                central: 500000
            });

            const [particles, setParticles] = useState([]);
            const [logs, setLogs] = useState([]);
            const [activeFlow, setActiveFlow] = useState(null);
            const [explanation, setExplanation] = useState("Bienvenido al simulador de flujos financieros. Selecciona una operación.");
            const [step, setStep] = useState(0);

            const addLog = (message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString('es-PE');
                setLogs(prev => [{ time: timestamp, msg: message, type }, ...prev].slice(0, 6));
            };

            const spawnParticle = (start, end, type, value, callback) => {
                const id = Math.random().toString(36).substr(2, 9);
                setParticles(prev => [...prev, { id, start, end, type, value, callback }]);
            };

            const removeParticle = (id) => {
                setParticles(prev => prev.filter(p => p.id !== id));
            };

            // --- Escenarios ---

            const runDeposit = () => {
                if (activeFlow) return;
                setActiveFlow('deposit');
                setStep(1);
                setExplanation("INICIO: El Cliente A deposita dinero. Esto es un PASIVO para el banco (deuda con el cliente).");
                addLog("Cliente A inicia depósito de S/ 1,000", "user");

                // Paso 1: Info (Validación KYC)
                spawnParticle('userA', 'bank', 'info', 'KYC', () => {
                setStep(2);
                setExplanation("VALIDACIÓN: El banco verifica identidad y origen de fondos (Prevención de Lavado de Activos).");
                addLog("Banco valida identidad y origen de fondos", "system");
                
                // Paso 2: Dinero Físico/Digital
                setTimeout(() => {
                    spawnParticle('userA', 'bank', 'money', 'S/ 1,000', () => {
                    setBalances(prev => ({
                        ...prev,
                        userA: prev.userA - 1000,
                        bank: prev.bank + 1000
                    }));
                    addLog("Dinero ingresa a bóveda/cuenta del Banco", "success");
                    
                    setStep(3);
                    setExplanation("ENCAJE LEGAL: El banco debe enviar un % al BCRP (ej. 10%) como reserva obligatoria.");

                    // Paso 3: Encaje al BCRP
                    setTimeout(() => {
                        spawnParticle('bank', 'central', 'money', 'S/ 100 (Encaje)', () => {
                        setBalances(prev => ({
                            ...prev,
                            bank: prev.bank - 100,
                            central: prev.central + 100
                        }));
                        addLog("S/ 100 transferidos al BCRP como Encaje Legal", "warning");
                        setExplanation("FIN: El banco tiene S/ 900 disponibles para prestar (Creación secundaria de dinero).");
                        setActiveFlow(null);
                        });
                    }, 1000);
                    });
                }, 1000);
                });
            };

            const runLoan = () => {
                if (activeFlow) return;
                setActiveFlow('loan');
                setStep(1);
                setExplanation("SOLICITUD: El Cliente B pide S/ 5,000. El banco evalúa riesgo crediticio (Score).");
                addLog("Cliente B solicita préstamo de S/ 5,000", "user");

                // Paso 1: Info (Evaluación de Riesgo)
                spawnParticle('userB', 'bank', 'info', 'Solicitud', () => {
                setStep(2);
                setExplanation("RIESGO: El banco consulta centrales de riesgo (Equifax/Sentinel). Si aprueba, cobra una tasa alta (TCEA).");
                addLog("Banco evalúa capacidad de pago y riesgo", "system");

                // Paso 2: Desembolso
                setTimeout(() => {
                    spawnParticle('bank', 'userB', 'money', 'S/ 5,000', () => {
                    setBalances(prev => ({
                        ...prev,
                        bank: prev.bank - 5000,
                        userB: prev.userB + 5000
                    }));
                    addLog("Desembolso exitoso a cuenta de Cliente B", "success");
                    setExplanation("SPREAD: El banco presta dinero de los ahorristas al 25% anual, mientras paga 4.5% al ahorrista. La diferencia es la ganancia.");
                    setActiveFlow(null);
                    });
                }, 1500);
                });
            };

            const runTransfer = () => {
                if (activeFlow) return;
                setActiveFlow('transfer');
                setStep(1);
                const monto = 500;
                const comision = 5;
                
                setExplanation("TRANSFERENCIA: Cliente A envía S/ 500 a Cliente B (otro banco). Paga comisión de S/ 5.");
                addLog(`Inicio Transferencia Interbancaria: S/ ${monto}`, "user");

                // Paso 1: Débito al Ahorrista
                spawnParticle('userA', 'bank', 'money', `S/ ${monto + comision}`, () => {
                setBalances(prev => ({
                    ...prev,
                    userA: prev.userA - (monto + comision),
                    bank: prev.bank + (monto + comision) 
                }));
                addLog("Débito en cuenta de origen + Comisión", "system");
                
                setStep(2);
                setExplanation("CÁMARA DE COMPENSACIÓN (CCE): El banco comunica la transferencia a través de la red segura.");

                // Paso 2: Validación por Red
                spawnParticle('bank', 'network', 'info', 'Validación CCE', () => {
                    
                    addLog(`Banco retiene comisión de ganancia: S/ ${comision}`, "warning");
                    
                    setTimeout(() => {
                    // Paso 3: Envío al destino
                    spawnParticle('bank', 'userB', 'money', `S/ ${monto}`, () => {
                        setBalances(prev => ({
                        ...prev,
                        bank: prev.bank - monto, 
                        userB: prev.userB + monto
                        }));
                        setStep(3);
                        setExplanation("LIQUIDACIÓN: El dinero llega al destinatario. La comisión se queda como ingreso operativo del banco.");
                        addLog("Abono exitoso en cuenta destino", "success");
                        setActiveFlow(null);
                    });
                    }, 1000);
                });
                });
            };

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans selection:bg-emerald-100 pb-10">
                
                {/* Header */}
                <header className="bg-slate-900 text-white p-6 shadow-xl">
                    <div className="max-w-6xl mx-auto flex justify-between items-center">
                    <div>
                        <h1 className="text-2xl font-bold flex items-center gap-2">
                        <Icons.Building2 className="text-emerald-400" />
                        Simulador Bancario: Flujo de Dinero e Información
                        </h1>
                        <p className="text-slate-400 text-sm mt-1">Visualización académica de Intermediación, Spread y Encaje Legal.</p>
                    </div>
                    <div className="flex gap-4 text-xs font-mono">
                        <div className="bg-slate-800 px-3 py-1 rounded border border-slate-700">
                        <span className="text-emerald-400">●</span> Valor (Dinero)
                        </div>
                        <div className="bg-slate-800 px-3 py-1 rounded border border-slate-700">
                        <span className="text-cyan-400">●</span> Datos (Info)
                        </div>
                    </div>
                    </div>
                </header>

                {/* Main Content */}
                <main className="max-w-6xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    {/* Left Column */}
                    <div className="space-y-6">
                    
                    {/* Controls */}
                    <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h2 className="text-sm font-bold uppercase tracking-wide text-slate-500 mb-4">Operaciones Disponibles</h2>
                        <div className="space-y-3">
                        <button 
                            onClick={runDeposit} 
                            disabled={!!activeFlow}
                            className="w-full flex items-center justify-between p-3 rounded-lg border hover:border-emerald-500 hover:bg-emerald-50 transition-all disabled:opacity-50 group"
                        >
                            <div className="flex items-center gap-3">
                            <div className="bg-emerald-100 p-2 rounded text-emerald-600 group-hover:scale-110 transition-transform"><Icons.Wallet size={18} /></div>
                            <div className="text-left">
                                <div className="font-bold text-slate-700">Depósito a Plazo</div>
                                <div className="text-xs text-slate-500">Captación de fondos</div>
                            </div>
                            </div>
                            <Icons.ArrowRight size={16} className="text-slate-300 group-hover:text-emerald-500" />
                        </button>

                        <button 
                            onClick={runLoan} 
                            disabled={!!activeFlow}
                            className="w-full flex items-center justify-between p-3 rounded-lg border hover:border-blue-500 hover:bg-blue-50 transition-all disabled:opacity-50 group"
                        >
                            <div className="flex items-center gap-3">
                            <div className="bg-blue-100 p-2 rounded text-blue-600 group-hover:scale-110 transition-transform"><Icons.Banknote size={18} /></div>
                            <div className="text-left">
                                <div className="font-bold text-slate-700">Préstamo Personal</div>
                                <div className="text-xs text-slate-500">Colocación de crédito</div>
                            </div>
                            </div>
                            <Icons.ArrowRight size={16} className="text-slate-300 group-hover:text-blue-500" />
                        </button>

                        <button 
                            onClick={runTransfer} 
                            disabled={!!activeFlow}
                            className="w-full flex items-center justify-between p-3 rounded-lg border hover:border-purple-500 hover:bg-purple-50 transition-all disabled:opacity-50 group"
                        >
                            <div className="flex items-center gap-3">
                            <div className="bg-purple-100 p-2 rounded text-purple-600 group-hover:scale-110 transition-transform"><Icons.Send size={18} /></div>
                            <div className="text-left">
                                <div className="font-bold text-slate-700">Transferencia (CCI)</div>
                                <div className="text-xs text-slate-500">Servicio de pagos + Comisión</div>
                            </div>
                            </div>
                            <Icons.ArrowRight size={16} className="text-slate-300 group-hover:text-purple-500" />
                        </button>
                        </div>
                    </div>

                    {/* Explanation Panel */}
                    <div className="bg-slate-800 text-slate-100 p-5 rounded-xl shadow-lg border-t-4 border-emerald-500">
                        <h2 className="text-emerald-400 font-bold flex items-center gap-2 mb-2">
                        <Icons.Info size={18} /> Análisis del Flujo
                        </h2>
                        <p className="text-sm leading-relaxed min-h-[80px]">{explanation}</p>
                    </div>

                    {/* Ledger */}
                    <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h2 className="text-sm font-bold uppercase tracking-wide text-slate-500 mb-4 flex justify-between">
                        Libro Mayor (Ledger)
                        <Icons.Activity size={16} />
                        </h2>
                        <div className="space-y-2 overflow-hidden">
                        {logs.length === 0 && <p className="text-center text-slate-400 text-xs py-4">Esperando transacciones...</p>}
                        {logs.map((log, i) => (
                            <div key={i} className="text-xs flex gap-2 items-start animate-in slide-in-from-left duration-300">
                            <span className="text-slate-400 font-mono whitespace-nowrap">{log.time}</span>
                            <span className={`
                                ${log.type === 'success' ? 'text-emerald-600 font-medium' : ''}
                                ${log.type === 'warning' ? 'text-amber-600 font-medium' : ''}
                                ${log.type === 'user' ? 'text-slate-800 font-bold' : ''}
                                ${log.type === 'info' ? 'text-slate-600' : ''}
                                ${log.type === 'system' ? 'text-blue-600' : ''}
                            `}>
                                {log.msg}
                            </span>
                            </div>
                        ))}
                        </div>
                    </div>
                    </div>

                    {/* Visual Canvas */}
                    <div className="lg:col-span-2 relative h-[600px] bg-slate-100 rounded-2xl border border-slate-300 shadow-inner overflow-hidden">
                    
                    {/* Grid */}
                    <div className="absolute inset-0 opacity-10" 
                        style={{ backgroundImage: 'radial-gradient(#94a3b8 1px, transparent 1px)', backgroundSize: '20px 20px' }}>
                    </div>

                    {/* Lines */}
                    <svg className="absolute inset-0 w-full h-full pointer-events-none stroke-slate-300" strokeWidth="2">
                        <path d="M 20% 50% L 50% 50%" className={activeFlow === 'deposit' || activeFlow === 'transfer' ? "stroke-emerald-400 stroke-[3px]" : ""} />
                        <path d="M 50% 50% L 80% 50%" className={activeFlow === 'loan' || activeFlow === 'transfer' ? "stroke-emerald-400 stroke-[3px]" : ""} />
                        <path d="M 50% 50% L 50% 20%" className={activeFlow === 'deposit' ? "stroke-amber-400 stroke-[3px] border-dashed" : "stroke-dashed"} strokeDasharray="5,5" />
                        <path d="M 50% 50% L 50% 80%" className={activeFlow ? "stroke-blue-400 stroke-[3px]" : ""} />
                    </svg>

                    {/* Entities */}
                    <EntityCard 
                        title="Cliente A" 
                        role="Ahorrista / Pagador"
                        type="person" 
                        icon={Icons.User} 
                        balance={balances.userA} 
                        position="left-[5%] top-1/2 -translate-y-1/2"
                        active={activeFlow === 'deposit' || activeFlow === 'transfer'}
                    />

                    <EntityCard 
                        title="Banco Comercial" 
                        role="Intermediario Financiero"
                        type="bank" 
                        icon={Icons.Building2} 
                        balance={balances.bank} 
                        position="left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2"
                        active={!!activeFlow}
                    />

                    <EntityCard 
                        title="Cliente B" 
                        role="Prestatario / Receptor"
                        type="person" 
                        icon={Icons.User} 
                        balance={balances.userB} 
                        position="right-[5%] top-1/2 -translate-y-1/2"
                        active={activeFlow === 'loan' || (activeFlow === 'transfer' && step > 2)}
                    />

                    <EntityCard 
                        title="BCRP" 
                        role="Regulador / Encaje"
                        type="central" 
                        icon={Icons.Landmark} 
                        balance={balances.central} 
                        position="left-1/2 top-[5%] -translate-x-1/2"
                        active={activeFlow === 'deposit' && step >= 2}
                    />

                    {/* Data Network */}
                    <div className={`absolute left-1/2 bottom-[10%] -translate-x-1/2 flex flex-col items-center gap-2 transition-all duration-300
                        ${activeFlow ? 'opacity-100 scale-100' : 'opacity-50 scale-90 grayscale'}
                    `}>
                        <div className="p-3 bg-blue-600 rounded-full text-white shadow-lg shadow-blue-500/30 animate-pulse">
                        <Icons.Database size={24} />
                        </div>
                        <div className="text-center">
                        <span className="text-xs font-bold text-slate-500 uppercase">Red de Datos</span>
                        <div className="text-[10px] text-slate-400">Swift / CCE / Reniec</div>
                        </div>
                    </div>

                    {/* Particles */}
                    {particles.map(p => (
                        <FlowParticle 
                        key={p.id}
                        start={p.start}
                        end={p.end}
                        type={p.type}
                        value={p.value}
                        onComplete={() => {
                            p.callback();
                            removeParticle(p.id);
                        }}
                        />
                    ))}

                    {/* Labels */}
                    <div className="absolute top-[35%] left-[28%] text-[10px] text-slate-400 bg-white/80 px-2 rounded -rotate-6">Tasa Pasiva (TREA)</div>
                    <div className="absolute top-[35%] right-[28%] text-[10px] text-slate-400 bg-white/80 px-2 rounded rotate-6">Tasa Activa (TCEA)</div>

                    </div>
                </main>
                
                {/* Footer */}
                <footer className="max-w-6xl mx-auto px-6 py-8 text-center text-slate-400 text-sm">
                    <p className="mb-2">
                    <strong>Conceptos Clave:</strong> 
                    <span className="mx-2 text-slate-600">Intermediación</span> | 
                    <span className="mx-2 text-slate-600">Spread (Ganancia)</span> | 
                    <span className="mx-2 text-slate-600">Riesgo Crediticio</span> | 
                    <span className="mx-2 text-slate-600">Encaje Legal</span>
                    </p>
                    <p className="text-xs opacity-70">
                    Nota: Los montos son referenciales para fines educativos. Las tasas de interés reales varían según el mercado.
                    </p>
                    <p className="text-xs font-semibold text-slate-500 mt-4">
                    Autor: Juan Cotrina
                    </p>
                </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BankingSimulator />);
    </script>
</body>
</html>
